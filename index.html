<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>ğŸ„ è–èª•ç¨®è˜¿è”” 2025 ğŸ¥•</title>
<style>
/* ---------- åŸºæœ¬æ¨£å¼ ---------- */
body{
  margin:0;
  font-family:"Nunito",sans-serif;
  text-align:center;
  overflow-x:hidden;
  background:linear-gradient(#b3e5ff,#fff);
  position:relative;
}
.snow{
  position:fixed;
  top:-10px;
  color:white;
  animation:fall linear infinite;
  z-index:2000;
  pointer-events:none;
}
@keyframes fall{to{transform:translateY(110vh);}}
#music-control{
  position:fixed;top:10px;right:10px;width:46px;height:46px;border-radius:50%;
  background:rgba(255,255,255,0.85);display:flex;justify-content:center;align-items:center;
  font-size:22px;cursor:pointer;box-shadow:0 0 8px rgba(0,0,0,0.3);z-index:2100;
}
/* ---------- é–å± ---------- */
#lockscreen{
  margin:60px auto;width:90%;max-width:420px;padding:25px;background:rgba(255,255,255,0.9);
  border-radius:15px;box-shadow:0 0 10px rgba(0,0,0,0.1);position:relative;z-index:1000;
}
#countdown{font-size:18px;color:#055;margin-bottom:10px;font-weight:bold;}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px;}
.day{background:#fff;border-radius:6px;padding:6px;font-size:14px;box-shadow:0 0 3px rgba(0,0,0,0.2);}
.day.checked{background:#90ee90;font-weight:bold;color:#064;}
.daylabel{grid-column:span 7;text-align:left;font-size:16px;font-weight:bold;margin-top:4px;color:#333;}
input[type=password]{padding:10px;width:80%;border-radius:8px;border:1.8px solid #88c;}
button{padding:10px 14px;margin:6px 5px;border:none;border-radius:8px;background:#ff9999;color:white;font-size:16px;cursor:pointer;}
button:hover{filter:brightness(1.08);}
button:disabled{opacity:0.5;cursor:not-allowed;}
/* ---------- éŠæˆ²ä¸»ç•«é¢ ---------- */
#game{display:none;position:relative;z-index:1000;}
#merryTitle{
  display:none;
  position:absolute;
  top:0;
  left:50%;
  transform:translateX(-50%);
  width:100%;
  font-size:2em;
  font-weight:bold;
  color:#ff5b5b;
  text-shadow:0 0 12px rgba(255,120,120,0.7);
  z-index:100;
  animation:xmasFloatIn 1.2s ease-out forwards,
           xmasGlow 2.5s ease-in-out infinite alternate;
}
@keyframes xmasFloatIn{
  from{opacity:0;transform:translate(-50%,-12px) scale(0.96);}
  to  {opacity:1;transform:translate(-50%,0) scale(1);}
}
@keyframes xmasGlow{
  from{ text-shadow:0 0 8px rgba(255,120,120,0.4); }
  to  { text-shadow:0 0 18px rgba(255,40,40,0.85); }
}
.container{
  max-width:520px;margin:10px auto;background:rgba(255,255,255,0.95);border-radius:15px;
  box-shadow:0 0 10px rgba(0,0,0,0.1);padding:15px;position:relative;
}
.value{font-size:18px;margin:4px 0;}
.progress-container{background:#ccc;border-radius:10px;margin:8px auto;width:90%;height:16px;overflow:hidden;}
.progress-bar{background:linear-gradient(90deg,#ffca28,#ff9100);height:100%;width:0%;transition:width 0.4s ease;}
#field{
  position:relative;width:100%;height:200px;border-radius:10px;overflow:hidden;margin-top:10px;
  transition:background 1s;z-index:1;
}
.ground{
  position:absolute;bottom:0;width:100%;height:60%;
  background:repeating-linear-gradient(45deg,#784,#693 12px);
}
.plant{position:absolute;transition:all .5s ease;font-size:2em;opacity:0;}
.plant.show{opacity:1;}
.icon{position:absolute;font-size:2em;opacity:0;}
#rabbit,#cat{bottom:40px;}
#rabbit.run{animation:rabbit 4s linear;}
#cat.run{animation:cat 4s linear;}
@keyframes rabbit{0%{right:-50px;opacity:1;}100%{right:110%;opacity:0;}}
@keyframes cat{0%{left:110%;opacity:1;}100%{left:-50px;opacity:0;}}
.controls{display:flex;flex-wrap:wrap;justify-content:center;gap:6px;margin-top:10px;}
.controls button{flex:1 1 45%;min-width:110px;}
@media(max-width:420px){.controls button{flex:1 1 100%;width:90%;}}
#rule-box{
  background:#eef;padding:8px;border-radius:8px;margin-top:6px;font-size:15px;
  line-height:1.4;display:none;text-align:left;
}
#toggle-rule{
  background:#88aaff;border:none;border-radius:8px;padding:6px 12px;color:#fff;font-weight:bold;
  cursor:pointer;margin-top:6px;
}
#eventBox{margin-top:8px;min-height:24px;font-weight:bold;color:#333;}
.bible-text{color:#c33;font-weight:bold;animation:shine 1s ease-in-out infinite alternate;}
@keyframes shine{0%{color:#c33;}100%{color:#f66;}}
/* ---------- å¤©æ°£ & ç‰¹æ•ˆ ---------- */
.star{position:absolute;width:2px;height:2px;background:white;border-radius:50%;animation:twinkle 2s infinite ease-in-out;}
@keyframes twinkle{0%,100%{opacity:0.5;}50%{opacity:1;}}
.meteor{
  position:absolute;width:100px;height:2px;
  background:linear-gradient(90deg,white,rgba(255,255,255,0));
  transform:rotate(45deg);animation:shootLeft 3s linear;
}
@keyframes shootLeft{
  0%{right:-100px;top:-20px;opacity:0;}
  10%{opacity:1;}
  100%{right:110%;top:100%;opacity:0;}
}
.bird{position:absolute;top:20px;left:-50px;font-size:1.6em;animation:birdfly 4s linear;}
@keyframes birdfly{0%{left:-50px;opacity:1;}100%{left:110%;opacity:0;}}
.sun{position:absolute;top:10px;right:10px;font-size:2em;animation:shineSun 2s ease-in-out infinite alternate;}
@keyframes shineSun{from{filter:brightness(1);}to{filter:brightness(1.5);}}
.snowflake{position:absolute;color:white;animation:dropSnow 4s linear;}
@keyframes dropSnow{0%{top:-10px;opacity:1;}100%{top:100%;opacity:0;}}
.rain{position:absolute;color:#00f;animation:dropRain 2s linear;}
@keyframes dropRain{0%{top:-10px;opacity:1;}100%{top:100%;opacity:0;}}
.flash{animation:flashRed 0.2s alternate 10;}
@keyframes flashRed{from{filter:brightness(1);}to{filter:brightness(1.5) sepia(1) hue-rotate(-20deg);}}
/* ---------- è–èª• Popup ---------- */
#xmasPopupOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2500;
}
#xmasPopup{
  position:relative;
  width:min(420px,90vw);
  background:linear-gradient(145deg,#ffffff,#f7fbff);
  border-radius:18px;
  padding:22px 22px 20px;
  box-shadow:0 12px 30px rgba(0,0,0,0.18);
  animation:xmasPopupIn .45s ease-out;
  overflow:hidden;
}
#xmasPopupClose{
  position:absolute;
  top:10px;
  right:10px;
  border:none;
  background:rgba(255,255,255,0.9);
  width:26px;
  height:26px;
  border-radius:999px;
  cursor:pointer;
  font-size:15px;
  line-height:1;
  box-shadow:0 0 6px rgba(0,0,0,0.15);
}
.xmas-popup-header{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-bottom:10px;
}
.xmas-title{
  font-size:20px;
  font-weight:700;
  color:#ff5b5b;
  text-shadow:0 0 10px rgba(255,150,150,0.6);
}
.xmas-emoji{font-size:24px;}
.xmas-popup-body{
  text-align:center;
  color:#333;
}
.xmas-main-text{
  margin:0 0 14px;
  line-height:1.6;
  font-size:15px;
}
.xmas-money{
  font-weight:700;
  color:#e53935;
}
.xmas-pics{
  display:flex;
  justify-content:center;
  gap:10px;
  margin:6px 0 12px;
}
.xmas-pic-card{
  background:rgba(255,255,255,0.9);
  border-radius:12px;
  padding:6px 8px 5px;
  box-shadow:0 3px 8px rgba(0,0,0,0.08);
  min-width:70px;
}
.xmas-pic-icon{font-size:26px;}
.xmas-pic-label{
  font-size:11px;
  margin-top:2px;
}
.xmas-snow-row{
  display:flex;
  justify-content:center;
  gap:12px;
  font-size:18px;
  opacity:0.8;
}
@keyframes xmasPopupIn{
  from{opacity:0;transform:translateY(20px) scale(0.96);}
  to  {opacity:1;transform:translateY(0) scale(1);}
}
</style>
</head>
<body>
<script>
for(let i=0;i<25;i++){
  let s=document.createElement('div');
  s.className='snow';s.textContent='â„ï¸';
  s.style.left=Math.random()*100+'%';
  s.style.fontSize=(10+Math.random()*10)+'px';
  s.style.animationDuration=(5+Math.random()*5)+'s';
  document.body.appendChild(s);
}
</script>
<div id="music-control">ğŸ”Š</div>
<audio id="bgm" loop preload="auto">
  <source src="bgm.mp3" type="audio/mpeg">
</audio>

<!-- è–èª• Popup -->
<div id="xmasPopupOverlay">
  <div id="xmasPopup">
    <button id="xmasPopupClose">âœ•</button>
    <div class="xmas-popup-header">
      <span class="xmas-emoji">ğŸ…</span>
      <span class="xmas-title">MERRY CHRISTMAS</span>
      <span class="xmas-emoji">ğŸ</span>
    </div>
    <div class="xmas-popup-body">
      <p class="xmas-main-text">
        è–èª•å¿«æ¨‚!! ğŸ„<br>
        è¦ªæ„›çš„å°å…”å­ ğŸ°<br>
        å¸Œæœ›ä½  enjoy æˆ‘ç‚ºä½ æº–å‚™å˜…
        <span class="xmas-money">ğŸ’µ 100 èšŠè–èª•ç¦®ç‰©</span> !!!
      </p>
      <div class="xmas-pics">
        <div class="xmas-pic-card">
          <div class="xmas-pic-icon">ğŸ°</div>
          <div class="xmas-pic-label">å°å…”å­</div>
        </div>
        <div class="xmas-pic-card">
          <div class="xmas-pic-icon">ğŸ„</div>
          <div class="xmas-pic-label">è–èª•æ¨¹</div>
        </div>
        <div class="xmas-pic-card">
          <div class="xmas-pic-icon">ğŸ</div>
          <div class="xmas-pic-label">ç¦®ç‰©ç›’</div>
        </div>
      </div>
      <div class="xmas-snow-row">
        <span>â„ï¸</span><span>â„ï¸</span><span>â„ï¸</span>
      </div>
    </div>
  </div>
</div>

<!-- é–å± -->
<div id="lockscreen">
 <h2>ğŸ„ è–èª•ç¨®è˜¿è”” ğŸ¥•</h2>
 <div id="countdown">è¼‰å…¥ä¸­...</div>
 <div class="daylabel">ğŸ… è–èª•æ‰“å¡æ—¥æ›†ï¼ˆ12æœˆ1â€“24ï¼‰</div>
 <div id="calendar" class="calendar"></div>
 <p>è«‹è¼¸å…¥æ´»å‹•å¯†ç¢¼ï¼š</p>
 <input type="password" id="pwd" placeholder="è¼¸å…¥å¯†ç¢¼"><br>
 <button id="loginBtn">ç™»å…¥</button>
 <p id="msg" style="color:red;"></p>
</div>

<!-- éŠæˆ² -->
<div id="game">
 <div id="merryTitle">ğŸ…â€¯MERRYâ€¯CHRISTMASâ€¯ğŸ</div>
 <div class="container">
  <h3>ğŸ‘©â€ğŸŒ¾â€¯è–èª•ç¨®è˜¿è””â€¯æ´»å‹•ç‰ˆ</h3>
  <div class="value" id="lastLoginText">ä¸Šä¸€æ¬¡ç™»å…¥ï¼š--</div>
  <div class="value" id="wild">ç¨®æ¤ä¸­ğŸ¥•ï¼š0</div>
  <div class="value" id="safe">éŠ€è¡Œå„²å€¼ğŸ’³ï¼š0</div>
  <div class="value" id="total">ç¸½æ”¶æˆï¼š0æ ¹</div>
  <div class="progress-container">
    <div class="progress-bar" id="bar"></div>
  </div>
  <div id="field">
    <div class="ground"></div>
    <div class="icon" id="rabbit">ğŸ‡</div>
    <div class="icon" id="cat">ğŸˆ</div>
  </div>
  <div class="controls">
   <button id="plantBtn">ç¨®è˜¿è”” ğŸŒ° (20/20)</button>
   <button id="waterBtn">æ·‹æ°´ ğŸ’§ (1/1)</button>
   <button id="bankBtn">å­˜å…¥éŠ€è¡Œ ğŸ’³</button>
   <button id="resetBtn" style="background:#77bb77;">ğŸ”„â€¯é‡æ–°é–‹å§‹</button>
   <button id="testBtn" style="background:#59c;">ğŸ„â€¯è–èª•æ¸¬è©¦</button>
   <button id="growTestBtn" style="background:#ffaa00;">ğŸ§ªâ€¯ä¸‹ä¸€éšæ®µæ¸¬è©¦</button>
  </div>
  <button id="toggle-rule">ğŸŒ±â€¯ç¨®æ¤è¦å‰‡</button>
  <div id="rule-box">
   ğŸŒ±â€¯<b>ç¨®æ¤è¦å‰‡ï¼š</b><br>
   æ¯æ£µè˜¿è””é™ç¨®ä¸€æ¬¡ã€æ¯æ—¥é™æ·‹ä¸€æ¬¡æ°´ã€‚<br>
   æ·‹ä¸€æ¬¡æ°´çš„æ”¶æˆâ€¯+3ï¼›å…©éšæ®µéƒ½æ·‹æ°´â€¯+5ï¼›æœªæ·‹æ°´â€¯+1ã€‚<br>
   æˆç†Ÿè˜¿è””å­˜å…¥éŠ€è¡Œå¾Œè®ŠæˆéŠ€è¡Œå„²å€¼ğŸ’³ã€‚<br>
   12æœˆ24æ—¥ç‚ºè–èª•ç¯€ï¼Œæ‰€æœ‰è˜¿è””è®Šæˆè–èª•æ¨¹ï¼ç¦®ç‰©ğŸ„ã€‚
  </div>
  <div id="eventBox">ğŸŒ¤â€¯æ­¡è¿å›ä¾†ï¼Œå°è¾²å¤«ï½</div>
 </div>
</div>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  const PASSWORD="carrot2025";

  // âœ… æ–°èˆŠæ‰“å¡ keyï¼šæ–° checkin2025ï¼ŒèˆŠ adventCheckin2025
  const CHECKIN_KEY_NEW="checkin2025";
  const CHECKIN_KEY_OLD="adventCheckin2025";

  // âœ… éŠæˆ² save keyï¼šæ–° v2ï¼ŒèˆŠ carrotGame2025
  const OLD_GAME_KEY="carrotGame2025";
  const GAME_SAVE_KEY="carrotGame2025_v2";
  const LAST_LOGIN_KEY="carrotLastLogin";

  const cal=document.getElementById("calendar");

  // è®€å–æ‰“å¡ï¼šå…ˆæ–°ï¼Œå†èˆŠï¼Œç„¶å¾Œå¯«å›æ–° key
  function loadCheckin(){
    let raw=localStorage.getItem(CHECKIN_KEY_NEW);
    let fromOld=false;
    if(!raw){
      raw=localStorage.getItem(CHECKIN_KEY_OLD);
      if(raw) fromOld=true;
    }
    let days=[];
    try{
      days=raw?JSON.parse(raw):[];
      if(!Array.isArray(days)) days=[];
    }catch(e){days=[];}
    if(fromOld){
      localStorage.setItem(CHECKIN_KEY_NEW,JSON.stringify(days));
    }
    return days;
  }

  let data=loadCheckin();

  const countdownEl=document.getElementById("countdown");
  function updateCountdown(){
    const now=new Date();
    const target=new Date(now.getFullYear(),11,24,0,0,0,0);
    const diff=target-now;
    if(diff<=0){
      countdownEl.textContent="ğŸ‰ ä»Šæ—¥å°±ä¿‚å¹³å®‰å¤œ / è–èª•å•¦ï¼";
      return;
    }
    const d=Math.floor(diff/86400000);
    const h=Math.floor(diff%86400000/3600000);
    countdownEl.textContent=`è·é›¢ 12 æœˆ 24 æ—¥ä»²æœ‰ ${d} æ—¥ ${h} å°æ™‚`;
  }
  updateCountdown();
  setInterval(updateCountdown,60000);

  const bgm=document.getElementById("bgm");
  const musicBtn=document.getElementById("music-control");
  let musicOn=false;
  musicBtn.addEventListener("click",()=>{
    musicOn=!musicOn;
    if(musicOn){
      bgm.play().catch(()=>{});
      musicBtn.textContent="ğŸ”ˆ";
    }else{
      bgm.pause();
      musicBtn.textContent="ğŸ”Š";
    }
  });

  // ç•«å‡º 1â€“24 è™Ÿæ ¼ä»”ï¼Œå·²æ‰“å¡çš„åŠ  checked
  for(let i=1;i<=24;i++){
    const d=document.createElement("div");
    d.className="day";d.textContent=i;
    if(data.includes(i)) d.classList.add("checked");
    cal.appendChild(d);
  }

  function formatDateStr(date){
    const y=date.getFullYear();
    const m=String(date.getMonth()+1).padStart(2,"0");
    const d=String(date.getDate()).padStart(2,"0");
    const hh=String(date.getHours()).padStart(2,"0");
    const mm=String(date.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${d} ${hh}:${mm}`;
  }

  document.getElementById("loginBtn").onclick=()=>{
    const pwd=document.getElementById("pwd").value.trim();
    if(pwd!==PASSWORD){
      document.getElementById("msg").textContent="âŒâ€¯å¯†ç¢¼éŒ¯èª¤";
      return;
    }
    const now=new Date();
    if(now.getMonth()==11 && now.getDate()<=24){
      const day=now.getDate();
      if(!data.includes(day)){
        data.push(day);
        localStorage.setItem(CHECKIN_KEY_NEW,JSON.stringify(data));
      }
    }

    const prevLogin=localStorage.getItem(LAST_LOGIN_KEY);
    if(prevLogin){
      setTimeout(()=>{
        const t=document.getElementById("lastLoginText");
        if(t) t.textContent="ä¸Šä¸€æ¬¡ç™»å…¥ï¼š"+prevLogin;
      },0);
    }else{
      setTimeout(()=>{
        const t=document.getElementById("lastLoginText");
        if(t) t.textContent="ä¸Šä¸€æ¬¡ç™»å…¥ï¼šç¬¬ä¸€æ¬¡ç™»å…¥ ğŸ‰";
      },0);
    }
    localStorage.setItem(LAST_LOGIN_KEY,formatDateStr(now));

    document.getElementById("lockscreen").style.display="none";
    document.getElementById("game").style.display="block";
    initGame();
  };

  function initGame(){
    const PLANT_MAX=20;
    const PLANT_REGEN_INTERVAL=5*60*1000;

    let seeds=[];
    let safeCarrot=0;
    let bankStored=0;
    let plantLimit=PLANT_MAX;
    let waterLimit=1;
    let plantRegenStart=null;
    let xmasTest=false;
    let dailyEvents=0;

    const field=document.getElementById("field");
    const eventBox=document.getElementById("eventBox");
    const wildEl=document.getElementById("wild");
    const safeEl=document.getElementById("safe");
    const totalEl=document.getElementById("total");
    const bar=document.getElementById("bar");
    const merryTitle=document.getElementById("merryTitle");
    const xmasPopupOverlay=document.getElementById("xmasPopupOverlay");
    const xmasPopupClose=document.getElementById("xmasPopupClose");

    function setXmasUI(show){
      if(show){
        merryTitle.style.display="block";
        xmasPopupOverlay.style.display="flex";
      }else{
        merryTitle.style.display="none";
        xmasPopupOverlay.style.display="none";
      }
    }
    const today=new Date();
    const isRealXmasEve=(today.getMonth()===11 && today.getDate()===24);
    if(isRealXmasEve) setXmasUI(true); else setXmasUI(false);
    xmasPopupClose.addEventListener("click",()=>{xmasPopupOverlay.style.display="none";});

    document.getElementById("toggle-rule").onclick=()=>{
      const box=document.getElementById("rule-box");
      box.style.display=(box.style.display==="none"||!box.style.display)?"block":"none";
    };

    function random(min,max){return Math.random()*(max-min)+min;}

    function updateFieldStyle(forceNormal=false){
      const now=new Date();
      const hour=now.getHours();
      const isRealXmas=(now.getMonth()==11 && now.getDate()==24);
      const isXmas=(!forceNormal)&&(isRealXmas||xmasTest);

      field.querySelectorAll('.star,.meteor').forEach(e=>e.remove());

      if(isXmas){
        field.style.background="linear-gradient(#001633 0%, #223355 40%, #eef5ff 40%, #eef5ff 100%)";
        field.querySelector(".ground").style.background=
          "repeating-linear-gradient(45deg,#ccd,#eef 12px)";
        for(let i=0;i<40;i++){
          let st=document.createElement("div");
          st.className="star";
          st.style.left=Math.random()*100+"%";
          st.style.top=Math.random()*40+"%";
          st.style.animationDelay=(Math.random()*2)+"s";
          field.appendChild(st);
        }
        if(Math.random()<0.4){
          let m=document.createElement("div");
          m.className="meteor";
          field.appendChild(m);
          setTimeout(()=>m.remove(),3000);
        }
      }else if(hour>=6 && hour<18){
        field.style.background="linear-gradient(#aee7ff 0%, #aee7ff 40%, #8be25d 40%, #8be25d 100%)";
        field.querySelector(".ground").style.background=
          "repeating-linear-gradient(45deg,#784,#693 12px)";
      }else{
        field.style.background="linear-gradient(#001233 0%, #223355 40%, #274a27 40%, #274a27 100%)";
        field.querySelector(".ground").style.background=
          "repeating-linear-gradient(45deg,#384,#274 12px)";
        for(let i=0;i<20;i++){
          const st=document.createElement("div");
          st.className="star";
          st.style.left=Math.random()*100+"%";
          st.style.top=Math.random()*30+"%";
          field.appendChild(st);
        }
      }
    }

    function updateUI(){
      const growing=seeds.filter(p=>p.stage!=="grown").length;
      const total=growing+safeCarrot;
      const rate=Math.min(Math.round((safeCarrot/400)*100),100);
      wildEl.textContent="ç¨®æ¤ä¸­ğŸ¥•ï¼š"+growing;
      safeEl.textContent="éŠ€è¡Œå„²å€¼ğŸ’³ï¼š"+safeCarrot;
      totalEl.textContent="ç¸½æ”¶æˆï¼š"+total+"æ ¹";
      document.getElementById("plantBtn").textContent=`ç¨®è˜¿è”” ğŸŒ° (${plantLimit}/${PLANT_MAX})`;
      document.getElementById("waterBtn").textContent=`æ·‹æ°´ ğŸ’§ (${waterLimit}/1)`;
      bar.style.width=rate+"%";
    }

    function updatePlantRegen(){
      if(plantRegenStart==null) return;
      if(plantLimit>=PLANT_MAX){
        plantRegenStart=null;
        return;
      }
      const now=Date.now();
      const elapsed=now-plantRegenStart;
      if(elapsed<PLANT_REGEN_INTERVAL) return;
      const canRegen=Math.floor(elapsed/PLANT_REGEN_INTERVAL);
      if(canRegen<=0) return;
      const old=plantLimit;
      const next=Math.min(plantLimit+canRegen,PLANT_MAX);
      plantLimit=next;
      if(plantLimit>=PLANT_MAX){
        plantRegenStart=null;
      }else{
        const used=next-old;
        plantRegenStart+=used*PLANT_REGEN_INTERVAL;
      }
      updateUI();
      saveGame();
    }

    function saveGame(){
      const simpleSeeds=seeds.map(p=>({
        stage:p.stage,
        wateredSeed:p.wateredSeed,
        wateredSprout:p.wateredSprout,
        plantedAt:p.plantedAt,
        left:p.el.style.left,
        bottom:p.el.style.bottom
      }));
      const data={
        seeds:simpleSeeds,
        safeCarrot,
        bankStored,
        plantLimit,
        waterLimit,
        plantRegenStart,
        xmasTest
      };
      localStorage.setItem(GAME_SAVE_KEY,JSON.stringify(data));
    }

    // è®€å–éŠæˆ²ï¼šå…ˆæ–° keyï¼Œå†èˆŠ keyï¼Œå†å­˜å›æ–° key
    function loadGame(){
      let raw=localStorage.getItem(GAME_SAVE_KEY);
      let fromOld=false;
      if(!raw){
        raw=localStorage.getItem(OLD_GAME_KEY);
        if(raw) fromOld=true;
      }
      if(!raw) return;
      try{
        const data=JSON.parse(raw);
        safeCarrot=data.safeCarrot??0;
        bankStored=data.bankStored??0;
        plantLimit=data.plantLimit??PLANT_MAX;
        waterLimit=data.waterLimit??1;
        plantRegenStart=data.plantRegenStart??null;
        xmasTest=data.xmasTest??false;

        seeds=(data.seeds||[]).map(p=>{
          const el=document.createElement("div");
          el.className="plant show";
          el.style.left=p.left || (Math.random()*80+10)+"%";
          el.style.bottom=p.bottom || (Math.random()*15+25)+"%";
          el.textContent="ğŸŒ°";
          field.appendChild(el);
          return{
            stage:p.stage || "seed",
            wateredSeed:!!p.wateredSeed,
            wateredSprout:!!p.wateredSprout,
            plantedAt:p.plantedAt || Date.now(),
            el
          };
        });

        recomputeGrowth(true);
        if(xmasTest){
          seeds.forEach(p=>p.el.textContent="ğŸ„");
          setXmasUI(true);
        }
        if(fromOld){
          saveGame();   // ç«‹å³å¯«ä¸€æ¬¡å»æ–° key
        }
      }catch(e){
        console.error("Load game failed:",e);
      }
    }

    function recomputeGrowth(init=false){
      const now=Date.now();
      const THREE_HOURS=3*60*60;
      const SIX_HOURS=6*60*60;
      let changed=false;
      seeds.forEach(p=>{
        const elapsedSec=(now-p.plantedAt)/1000;
        let newStage="seed";
        if(elapsedSec>=SIX_HOURS) newStage="grown";
        else if(elapsedSec>=THREE_HOURS) newStage="sprout";

        if(newStage!==p.stage || init){
          p.stage=newStage;
          if(newStage==="seed") p.el.textContent="ğŸŒ°";
          else if(newStage==="sprout") p.el.textContent="ğŸŒ¿";
          else if(newStage==="grown") p.el.textContent="ğŸ¥•";
          changed=true;
        }
      });
      if(changed && !init) saveGame();
      updateUI();
    }

    function checkXmasAuto(){
      const date=new Date();
      if(date.getMonth()==11 && date.getDate()==24 && !xmasTest){
        seeds.forEach(p=>p.el.textContent="ğŸ„");
        eventBox.textContent="ğŸ„â€¯è–èª•ç¯€åˆ°ï¼æ‰€æœ‰è˜¿è””è®Šæˆè–èª•æ¨¹ï¼";
        updateFieldStyle();
        setXmasUI(true);
        saveGame();
      }
    }

    loadGame();
    updateFieldStyle(true);
    updatePlantRegen();
    updateUI();

    document.getElementById("plantBtn").onclick=()=>{
      if(plantLimit<=0){
        eventBox.textContent="ğŸŒ° ç¨®å­ç”¨å®Œäº†ï¼Œç­‰ä¸€ç­‰æœƒè‡ªå‹•å›å¾©ï½";
        return;
      }
      plantLimit--;
      if(plantLimit===0 && plantRegenStart==null){
        plantRegenStart=Date.now();
      }
      const el=document.createElement("div");
      el.className="plant show";el.textContent="ğŸŒ°";
      el.style.left=random(5,85)+"%";
      el.style.bottom=random(25,40)+"%";
      field.appendChild(el);
      seeds.push({
        stage:"seed",
        wateredSeed:false,
        wateredSprout:false,
        plantedAt:Date.now(),
        el
      });
      eventBox.textContent="ğŸŒ±â€¯æ–°è˜¿è””ç¨®ä¸‹ï½";
      updateUI();
      saveGame();
    };

    document.getElementById("waterBtn").onclick=()=>{
      if(waterLimit<=0)return;
      waterLimit--;
      seeds.forEach(p=>{
        if(p.stage==="seed") p.wateredSeed=true;
        else if(p.stage==="sprout") p.wateredSprout=true;
      });
      eventBox.textContent="ğŸ’§â€¯æ·‹æ°´å®Œæˆï¼";
      updateUI();
      saveGame();
    };

    document.getElementById("bankBtn").onclick=()=>{
      const today=new Date();
      const isXmas=(today.getMonth()==11 && today.getDate()==24)||xmasTest;
      if(isXmas){
        eventBox.innerHTML="<span class='bible-text'>ğŸâ€¯è–èª•å¿«æ¨‚ï¼å»éŠ€è¡Œçœ‹ç¦®ç‰©ï½</span>";
        return;
      }
      let harvested=0;
      seeds=seeds.filter(p=>{
        if(p.stage==="grown"){
          let add=1;
          if(p.wateredSeed&&p.wateredSprout) add=5;
          else if(p.wateredSeed||p.wateredSprout) add=3;
          harvested+=add;
          setTimeout(()=>p.el.remove(),500);
          return false;
        }
        return true;
      });
      if(harvested>0){
        safeCarrot+=harvested;
        bankStored+=harvested;
        eventBox.textContent=`ğŸ’³â€¯æ”¶æˆâ€¯${harvested}â€¯æ ¹ï¼Œå­˜å…¥éŠ€è¡Œï¼`;
      }else{
        eventBox.textContent="å†‡æˆç†Ÿè˜¿è””ï½";
      }
      updateUI();
      saveGame();
    };

    document.getElementById("resetBtn").onclick=()=>{
      if(confirm("ç¢ºå®šè¦é‡è¨­ï¼Ÿï¼ˆåŒ…æ‹¬æ¸…é™¤æœ¬æ©Ÿç´€éŒ„ï¼‰")){
        localStorage.removeItem(GAME_SAVE_KEY);
        localStorage.removeItem(OLD_GAME_KEY);
        localStorage.removeItem(CHECKIN_KEY_NEW);
        localStorage.removeItem(CHECKIN_KEY_OLD);
        localStorage.removeItem(LAST_LOGIN_KEY);
        location.reload();
      }
    };

    document.getElementById("testBtn").onclick=()=>{
      xmasTest=!xmasTest;
      const now=new Date();
      const isRealXmas=(now.getMonth()==11 && now.getDate()==24);
      const isXmasMode=isRealXmas||xmasTest;
      if(isXmasMode){
        seeds.forEach(p=>p.el.textContent="ğŸ„");
        eventBox.textContent="ğŸ§ª å·²é–‹å•Ÿè–èª•æ¸¬è©¦æ¨¡å¼ï¼Œè˜¿è””è®Šæˆè–èª•æ¨¹ï½";
        setXmasUI(true);
      }else{
        recomputeGrowth(true);
        eventBox.textContent="ğŸ§ª å·²é—œé–‰è–èª•æ¸¬è©¦æ¨¡å¼ï½";
        if(!isRealXmas) setXmasUI(false);
      }
      updateFieldStyle();
      saveGame();
    };

    document.getElementById("growTestBtn").onclick=()=>{
      seeds.forEach(p=>{
        if(p.stage==="seed"){p.stage="sprout";p.el.textContent="ğŸŒ¿";}
        else if(p.stage==="sprout"){p.stage="grown";p.el.textContent="ğŸ¥•";}
      });
      eventBox.textContent="ğŸ§ªâ€¯æ‰€æœ‰æ¤ç‰©å‰é€²ä¸€å€‹éšæ®µ";
      saveGame();
      updateUI();
    };

    setInterval(()=>{
      checkXmasAuto();
      const date=new Date();
      const isXmas=(date.getMonth()==11 && date.getDate()==24)||xmasTest;
      if(isXmas){
        seeds.forEach(p=>p.el.textContent="ğŸ„");
        updateFieldStyle();
        return;
      }
      recomputeGrowth(false);
      updateFieldStyle();
    },60000);

    setInterval(()=>{updatePlantRegen();},10000);

    setInterval(()=>{
      if(dailyEvents>=2) return;
      if(Math.random()<0.3){
        dailyEvents++;
        triggerEvent();
      }
    },45000);

    function triggerEvent(){
      const r=Math.random();
      if(r<0.15)      birdEvent();
      else if(r<0.3)  sunEvent();
      else if(r<0.4)  lavaEvent();
      else if(r<0.5)  snowEvent();
      else if(r<0.6)  rainEvent();
      else if(r<0.7)  catSteal();
      else if(r<0.8)  catWater();
      else if(r<0.9)  rabbitHelp();
      else            rabbitEat();
    }
    function birdEvent(){
      if(seeds.length>0) seeds.pop();
      const b=document.createElement("div");
      b.className="bird";b.textContent="ğŸ¦";
      field.appendChild(b);
      eventBox.textContent="ğŸ¦â€¯å°é³¥åƒæ‰è˜¿è””â€¯-1";
      setTimeout(()=>b.remove(),4000);
      updateUI();saveGame();
    }
    function sunEvent(){
      const s=document.createElement("div");
      s.className="sun";s.textContent="â˜€ï¸";
      field.appendChild(s);
      safeCarrot+=2;
      eventBox.textContent="â˜€ï¸â€¯é™½å…‰æ™®ç…§â€¯+2â€¯è˜¿è””";
      setTimeout(()=>s.remove(),4000);
      updateUI();saveGame();
    }
    function lavaEvent(){
      eventBox.textContent="ğŸŒ‹â€¯ç†”å²©ç‡’äº†è˜¿è””ï¼";
      seeds=seeds.slice(0,1);
      document.body.classList.add("flash");
      setTimeout(()=>document.body.classList.remove("flash"),10000);
      updateUI();saveGame();
    }
    function snowEvent(){
      if(seeds.length>0) seeds.pop();
      for(let i=0;i<15;i++){
        const s=document.createElement("div");
        s.className="snowflake";s.textContent="â„ï¸";
        s.style.left=Math.random()*100+"%";
        field.appendChild(s);
        setTimeout(()=>s.remove(),4000);
      }
      eventBox.textContent="â„ï¸â€¯ä¸‹é›ªâ€¯è˜¿è””â€¯-1";
      updateUI();saveGame();
    }
    function rainEvent(){
      safeCarrot+=2;
      for(let i=0;i<20;i++){
        const r=document.createElement("div");
        r.className="rain";r.textContent="ğŸ’§";
        r.style.left=Math.random()*100+"%";
        field.appendChild(r);
        setTimeout(()=>r.remove(),2000);
      }
      eventBox.textContent="ğŸ’§â€¯è½é›¨â€¯è˜¿è””â€¯+2";
      updateUI();saveGame();
    }
    function catSteal(){
      if(seeds.length>0) seeds.pop();
      const c=document.getElementById("cat");
      c.classList.add("run");
      eventBox.textContent="ğŸˆâ€¯å°è²“å·èµ°è˜¿è””â€¯å–µï½";
      setTimeout(()=>c.classList.remove("run"),4000);
      updateUI();saveGame();
    }
    function catWater(){
      safeCarrot+=1;
      eventBox.textContent="ğŸ¾â€¯å°è²“å¹«å¿™æ·‹æ°´â€¯+1";
      const drop=document.createElement("div");
      drop.className="rain";drop.textContent="ğŸ’§";
      drop.style.left="50%";drop.style.animationDuration="1s";
      field.appendChild(drop);
      setTimeout(()=>drop.remove(),1000);
      updateUI();saveGame();
    }
    function rabbitHelp(){
      safeCarrot+=1;
      const r=document.getElementById("rabbit");
      r.classList.add("run");
      eventBox.textContent="ğŸ‡â€¯å°å…”å¹«ç¿»åœ°â€¯+1";
      setTimeout(()=>r.classList.remove("run"),4000);
      updateUI();saveGame();
    }
    function rabbitEat(){
      if(seeds.length>0) seeds.pop();
      const r=document.getElementById("rabbit");
      r.classList.add("run");
      eventBox.textContent="ğŸ‡â€¯å°å…”è²ªé£Ÿâ€¯å’¬è˜¿è””â€¯ğŸ¤£";
      setTimeout(()=>r.classList.remove("run"),4000);
      updateUI();saveGame();
    }
  }
});
</script>
</body>
</html>
